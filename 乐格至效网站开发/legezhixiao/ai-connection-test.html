<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯AIåŠ©æ‰‹è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #005aa3;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .input-group textarea {
            height: 80px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– å‰ç«¯AIåŠ©æ‰‹è¿æ¥æµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>ğŸ” åŸºç¡€è¿æ¥æµ‹è¯•</h2>
        <button class="test-button" onclick="testBasicConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
        <button class="test-button" onclick="testHealthCheck()">å¥åº·æ£€æŸ¥</button>
        <div id="basicResult" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>ğŸ§  AIå¯¹è¯æµ‹è¯•</h2>
        <div class="input-group">
            <label for="testMessage">æµ‹è¯•æ¶ˆæ¯:</label>
            <textarea id="testMessage" placeholder="è¾“å…¥è¦å‘é€ç»™AIçš„æ¶ˆæ¯...">è¯·å¸®æˆ‘å†™ä¸€ä¸ªå…³äºæ˜Ÿç©ºçš„çŸ­è¯—</textarea>
        </div>
        <div class="input-group">
            <label for="messageType">æ¶ˆæ¯ç±»å‹:</label>
            <select id="messageType">
                <option value="general">é€šç”¨</option>
                <option value="continuation">ç»­å†™</option>
                <option value="improvement">æ”¹è¿›</option>
                <option value="correction">ä¿®æ­£</option>
            </select>
        </div>
        <button class="test-button" onclick="testAIChat()">å‘é€AIæ¶ˆæ¯</button>
        <button class="test-button" onclick="testDirectAPI()">ç›´æ¥APIæµ‹è¯•</button>
        <div id="aiResult" class="test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>ğŸ“± å‰ç«¯æœåŠ¡æµ‹è¯•</h2>
        <button class="test-button" onclick="testFrontendAIService()">æµ‹è¯•å‰ç«¯AIæœåŠ¡</button>
        <button class="test-button" onclick="testFloatingWindow()">æµ‹è¯•æ‚¬æµ®çª—æœåŠ¡</button>
        <div id="frontendResult" class="test-result"></div>
    </div>

    <script>
        let isLoading = false;

        function setLoading(elementId, loading) {
            isLoading = loading;
            const element = document.getElementById(elementId);
            if (loading) {
                element.className = 'test-result loading';
                element.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•...';
            }
            document.querySelectorAll('.test-button').forEach(btn => {
                btn.disabled = loading;
            });
        }

        function showResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.className = `test-result ${success ? 'success' : 'error'}`;
            element.textContent = message;
            isLoading = false;
            document.querySelectorAll('.test-button').forEach(btn => {
                btn.disabled = false;
            });
        }

        async function testBasicConnection() {
            if (isLoading) return;
            setLoading('basicResult', true);
            
            try {
                const response = await fetch('http://localhost:3000/api/ai');
                const data = await response.json();
                
                showResult('basicResult', true, 
                    `âœ… åç«¯è¿æ¥æˆåŠŸï¼\n` +
                    `çŠ¶æ€ç : ${response.status}\n` +
                    `å“åº”: ${JSON.stringify(data, null, 2)}`
                );
            } catch (error) {
                showResult('basicResult', false, 
                    `âŒ åç«¯è¿æ¥å¤±è´¥ï¼\n` +
                    `é”™è¯¯: ${error.message}\n` +
                    `æ£€æŸ¥åç«¯æ˜¯å¦åœ¨ http://localhost:3000 è¿è¡Œ`
                );
            }
        }

        async function testHealthCheck() {
            if (isLoading) return;
            setLoading('basicResult', true);
            
            try {
                const response = await fetch('http://localhost:3000/api/ai/health');
                const data = await response.json();
                
                showResult('basicResult', true, 
                    `âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼\n` +
                    `çŠ¶æ€ç : ${response.status}\n` +
                    `æœåŠ¡çŠ¶æ€: ${data.status}\n` +
                    `å“åº”æ—¶é—´: ${data.timestamp}\n` +
                    `è¯¦ç»†ä¿¡æ¯: ${JSON.stringify(data, null, 2)}`
                );
            } catch (error) {
                showResult('basicResult', false, 
                    `âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼\n` +
                    `é”™è¯¯: ${error.message}`
                );
            }
        }

        async function testDirectAPI() {
            if (isLoading) return;
            setLoading('aiResult', true);
            
            const message = document.getElementById('testMessage').value;
            const type = document.getElementById('messageType').value;
            
            try {
                const startTime = Date.now();
                const response = await fetch('http://localhost:3000/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        type: type,
                        maxTokens: 500
                    })
                });
                
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                showResult('aiResult', true, 
                    `âœ… AI APIè°ƒç”¨æˆåŠŸï¼\n` +
                    `å“åº”æ—¶é—´: ${duration}ms\n` +
                    `AIç±»å‹: ${data.type}\n` +
                    `AIå›å¤: ${data.text}\n` +
                    `ç½®ä¿¡åº¦: ${data.confidence}\n` +
                    `æä¾›å•†: ${data.provider}\n` +
                    `å®Œæ•´å“åº”: ${JSON.stringify(data, null, 2)}`
                );
            } catch (error) {
                showResult('aiResult', false, 
                    `âŒ AI APIè°ƒç”¨å¤±è´¥ï¼\n` +
                    `é”™è¯¯: ${error.message}\n` +
                    `è¯·æ£€æŸ¥åç«¯AIæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ`
                );
            }
        }

        async function testAIChat() {
            if (isLoading) return;
            setLoading('aiResult', true);
            
            const message = document.getElementById('testMessage').value;
            const type = document.getElementById('messageType').value;
            
            // æ¨¡æ‹Ÿå‰ç«¯aiServiceçš„è°ƒç”¨æ–¹å¼
            try {
                const startTime = Date.now();
                
                // ä½¿ç”¨å’Œå‰ç«¯ç›¸åŒçš„æ–¹å¼è°ƒç”¨
                const response = await fetch('http://localhost:3000/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        type: type,
                        maxTokens: 1000
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                showResult('aiResult', true, 
                    `âœ… å‰ç«¯æ¨¡æ‹ŸAIè°ƒç”¨æˆåŠŸï¼\n` +
                    `å“åº”æ—¶é—´: ${duration}ms\n` +
                    `æ¶ˆæ¯ID: ${data.id}\n` +
                    `ç±»å‹: ${data.type}\n` +
                    `AIå›å¤:\n${data.text}\n\n` +
                    `ç½®ä¿¡åº¦: ${data.confidence}\n` +
                    `åŸå› : ${data.reason}\n` +
                    `æä¾›å•†: ${data.provider}`
                );
            } catch (error) {
                console.error('AIè°ƒç”¨é”™è¯¯:', error);
                showResult('aiResult', false, 
                    `âŒ å‰ç«¯æ¨¡æ‹ŸAIè°ƒç”¨å¤±è´¥ï¼\n` +
                    `é”™è¯¯ç±»å‹: ${error.constructor.name}\n` +
                    `é”™è¯¯æ¶ˆæ¯: ${error.message}\n` +
                    `è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡çŠ¶æ€`
                );
            }
        }

        async function testFrontendAIService() {
            if (isLoading) return;
            setLoading('frontendResult', true);
            
            try {
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—®å‰ç«¯çš„AIæœåŠ¡æ¨¡å—
                const testCode = `
                    // å°è¯•åŠ è½½å‰ç«¯AIæœåŠ¡
                    if (window.location.origin === 'http://localhost:5173') {
                        // æˆ‘ä»¬åœ¨å‰ç«¯ç¯å¢ƒä¸­
                        return 'FRONTEND_ENV';
                    } else {
                        // åœ¨æµ‹è¯•é¡µé¢ä¸­ï¼Œæ¨¡æ‹Ÿå‰ç«¯è°ƒç”¨
                        return 'TEST_ENV';
                    }
                `;
                
                const env = eval(testCode);
                
                showResult('frontendResult', true, 
                    `âœ… å‰ç«¯ç¯å¢ƒæ£€æµ‹æˆåŠŸï¼\n` +
                    `å½“å‰ç¯å¢ƒ: ${env}\n` +
                    `æµè§ˆå™¨: ${navigator.userAgent}\n` +
                    `å½“å‰é¡µé¢: ${window.location.href}\n\n` +
                    `å»ºè®®: è¯·åœ¨å‰ç«¯åº”ç”¨ (http://localhost:5173) ä¸­æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œ\n` +
                    `è¿è¡Œä»¥ä¸‹ä»£ç æµ‹è¯•AIåŠ©æ‰‹:\n\n` +
                    `// æµ‹è¯•å‰ç«¯AIæœåŠ¡\n` +
                    `if (window.aiService) {\n` +
                    `    window.aiService.generateResponse({\n` +
                    `        message: "ä½ å¥½ï¼ŒAIåŠ©æ‰‹ï¼",\n` +
                    `        type: "general"\n` +
                    `    }).then(response => {\n` +
                    `        console.log("AIå›å¤:", response);\n` +
                    `    }).catch(error => {\n` +
                    `        console.error("AIè°ƒç”¨å¤±è´¥:", error);\n` +
                    `    });\n` +
                    `} else {\n` +
                    `    console.log("AIæœåŠ¡æœªåŠ è½½");\n` +
                    `}`
                );
            } catch (error) {
                showResult('frontendResult', false, 
                    `âŒ å‰ç«¯æœåŠ¡æµ‹è¯•å¤±è´¥ï¼\n` +
                    `é”™è¯¯: ${error.message}`
                );
            }
        }

        async function testFloatingWindow() {
            if (isLoading) return;
            setLoading('frontendResult', true);
            
            try {
                showResult('frontendResult', true, 
                    `ğŸ” æ‚¬æµ®çª—æµ‹è¯•æŒ‡å—\n\n` +
                    `1. æ‰“å¼€å‰ç«¯åº”ç”¨: http://localhost:5173\n` +
                    `2. æŸ¥æ‰¾AIåŠ©æ‰‹æ‚¬æµ®çª— (é€šå¸¸åœ¨å³ä¸‹è§’)\n` +
                    `3. ç‚¹å‡»AIåŠ©æ‰‹å›¾æ ‡æ‰“å¼€å¯¹è¯çª—å£\n` +
                    `4. å‘é€æµ‹è¯•æ¶ˆæ¯: "ä½ å¥½ï¼Œè¯·å¸®æˆ‘å†™ä¸€é¦–è¯—"\n` +
                    `5. è§‚å¯Ÿæ˜¯å¦æ”¶åˆ°AIå›å¤\n\n` +
                    `å¦‚æœçœ‹ä¸åˆ°æ‚¬æµ®çª—ï¼Œè¯·æ£€æŸ¥:\n` +
                    `- æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯\n` +
                    `- FloatingAIWindowç»„ä»¶æ˜¯å¦æ­£ç¡®æ¸²æŸ“\n` +
                    `- CSSæ ·å¼æ˜¯å¦æ­£ç¡®åŠ è½½\n\n` +
                    `è°ƒè¯•ä»£ç  (åœ¨å‰ç«¯æ§åˆ¶å°è¿è¡Œ):\n` +
                    `console.log("AIæœåŠ¡çŠ¶æ€:", window.aiService ? "å·²åŠ è½½" : "æœªåŠ è½½");\n` +
                    `document.querySelectorAll('[class*="floating"], [class*="ai"]').forEach(el => {\n` +
                    `    console.log("å‘ç°AIç›¸å…³å…ƒç´ :", el.className, el);\n` +
                    `});`
                );
            } catch (error) {
                showResult('frontendResult', false, 
                    `âŒ æ‚¬æµ®çª—æµ‹è¯•å¤±è´¥ï¼\n` +
                    `é”™è¯¯: ${error.message}`
                );
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•åŸºç¡€è¿æ¥
        window.addEventListener('load', () => {
            console.log('ğŸš€ AIåŠ©æ‰‹æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('ğŸ“ å½“å‰é¡µé¢:', window.location.href);
            console.log('ğŸ”— åç«¯åœ°å€:', 'http://localhost:3000');
            console.log('ğŸ–¥ï¸ å‰ç«¯åœ°å€:', 'http://localhost:5173');
            
            // 3ç§’åè‡ªåŠ¨æµ‹è¯•åŸºç¡€è¿æ¥
            setTimeout(testBasicConnection, 1000);
        });
    </script>
</body>
</html>
