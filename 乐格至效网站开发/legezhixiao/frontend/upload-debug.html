<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ–‡ä»¶ä¸Šä¼ è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h3>1. è·å–Token</h3>
        <button onclick="getToken()">è·å–ç™»å½•Token</button>
        <div id="tokenResult"></div>
    </div>
    
    <div class="section">
        <h3>2. éªŒè¯Token</h3>
        <button onclick="verifyToken()">éªŒè¯Token</button>
        <div id="verifyResult"></div>
    </div>
    
    <div class="section">
        <h3>3. åˆ›å»ºæµ‹è¯•æ–‡ä»¶</h3>
        <button onclick="createTestFile()">åˆ›å»ºæµ‹è¯•æ–‡ä»¶</button>
        <div id="fileResult"></div>
    </div>
    
    <div class="section">
        <h3>4. ä¸Šä¼ æ–‡ä»¶</h3>
        <input type="file" id="fileInput" accept=".txt,.md,.docx,.pdf,.html,.rtf">
        <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
        <div id="uploadResult"></div>
    </div>
    
    <div class="section">
        <h3>5. è°ƒè¯•ä¿¡æ¯</h3>
        <div id="debugInfo"></div>
    </div>

    <script>
        let currentToken = null;
        let testFile = null;
        
        function log(message, data = null) {
            console.log(message, data);
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            if (data) {
                debugDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        }
        
        async function getToken() {
            const resultDiv = document.getElementById('tokenResult');
            
            try {
                log('ğŸ”‘ å¼€å§‹è·å–Token...');
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@legezhixiao.com',
                        password: 'lekairong8888',
                        rememberMe: true
                    })
                });
                
                const result = await response.json();
                log('ç™»å½•å“åº”', {status: response.status, result});
                
                if (result.success) {
                    currentToken = result.data.accessToken;
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `âœ… Tokenè·å–æˆåŠŸ<br>Token: ${currentToken.substring(0, 30)}...`;
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('access_token', currentToken);
                    localStorage.setItem('current_user', JSON.stringify(result.data.user));
                    
                    log('âœ… Tokenå·²ä¿å­˜åˆ°localStorage');
                } else {
                    resultDiv.className = 'error';
                    resultDiv.textContent = `âŒ ç™»å½•å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                log('âŒ è·å–Tokenå¤±è´¥', error);
                resultDiv.className = 'error';
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
        }
        
        async function verifyToken() {
            const resultDiv = document.getElementById('verifyResult');
            
            if (!currentToken) {
                currentToken = localStorage.getItem('access_token');
            }
            
            if (!currentToken) {
                resultDiv.className = 'error';
                resultDiv.textContent = 'âŒ è¯·å…ˆè·å–Token';
                return;
            }
            
            try {
                log('ğŸ” éªŒè¯Token...', {token: currentToken.substring(0, 30) + '...'});
                
                const response = await fetch('/api/auth/verify-token', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                log('TokenéªŒè¯å“åº”', {status: response.status, result});
                
                if (response.ok && result.success) {
                    resultDiv.className = 'success';
                    resultDiv.textContent = 'âœ… Tokenæœ‰æ•ˆ';
                } else {
                    resultDiv.className = 'error';
                    resultDiv.textContent = `âŒ Tokenæ— æ•ˆ: ${result.message}`;
                }
            } catch (error) {
                log('âŒ TokenéªŒè¯å¤±è´¥', error);
                resultDiv.className = 'error';
                resultDiv.textContent = `âŒ éªŒè¯é”™è¯¯: ${error.message}`;
            }
        }
        
        function createTestFile() {
            const resultDiv = document.getElementById('fileResult');
            
            try {
                log('ğŸ“„ åˆ›å»ºæµ‹è¯•æ–‡ä»¶...');
                
                const content = `è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å°è¯´æ–‡ä»¶ã€‚

ç¬¬ä¸€ç«  å¼€å§‹

åœ¨å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œæœ‰ä¸€ä¸ªç¾ä¸½çš„ç‹å›½...è¿™é‡Œæœ‰å¾ˆå¤šæ•…äº‹ã€‚

ç¬¬äºŒç«  ç»§ç»­

æ•…äº‹ç»§ç»­è¿›è¡Œï¼Œä¸»è§’å¼€å§‹äº†æ–°çš„å†’é™©...`;
                
                testFile = new File([content], 'debug-test.txt', {type: 'text/plain'});
                
                log('âœ… æµ‹è¯•æ–‡ä»¶åˆ›å»ºæˆåŠŸ', {
                    name: testFile.name,
                    size: testFile.size,
                    type: testFile.type
                });
                
                resultDiv.className = 'success';
                resultDiv.innerHTML = `âœ… æµ‹è¯•æ–‡ä»¶åˆ›å»ºæˆåŠŸ<br>æ–‡ä»¶å: ${testFile.name}<br>å¤§å°: ${testFile.size} bytes<br>ç±»å‹: ${testFile.type}`;
            } catch (error) {
                log('âŒ æ–‡ä»¶åˆ›å»ºå¤±è´¥', error);
                resultDiv.className = 'error';
                resultDiv.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`;
            }
        }
        
        async function uploadFile() {
            const resultDiv = document.getElementById('uploadResult');
            const fileInput = document.getElementById('fileInput');
            
            const file = fileInput.files[0] || testFile;
            
            if (!file) {
                resultDiv.className = 'error';
                resultDiv.textContent = 'âŒ è¯·é€‰æ‹©æ–‡ä»¶æˆ–åˆ›å»ºæµ‹è¯•æ–‡ä»¶';
                return;
            }
            
            if (!currentToken) {
                currentToken = localStorage.getItem('access_token');
            }
            
            if (!currentToken) {
                resultDiv.className = 'error';
                resultDiv.textContent = 'âŒ è¯·å…ˆè·å–Token';
                return;
            }
            
            try {
                log('ğŸ“¤ å¼€å§‹ä¸Šä¼ æ–‡ä»¶...', {
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    token: currentToken.substring(0, 30) + '...'
                });
                
                const formData = new FormData();
                formData.append('novel', file);
                
                log('ğŸ“¦ FormDataå‡†å¤‡å®Œæˆ');
                
                const response = await fetch('/api/upload/parse', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                        // æ³¨æ„ï¼šä¸è¦è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®multipart/form-dataè¾¹ç•Œ
                    },
                    body: formData
                });
                
                log('ğŸ“¥ æ”¶åˆ°æœåŠ¡å™¨å“åº”', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                let result;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    log('âš ï¸ æœåŠ¡å™¨è¿”å›éJSONå“åº”', {text});
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${text.substring(0, 100)}`);
                }
                
                log('ğŸ“Š è§£æå“åº”', result);
                
                if (response.ok && result.success) {
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `âœ… ${result.message}<br><pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                    log('âœ… ä¸Šä¼ æˆåŠŸ!');
                } else {
                    resultDiv.className = 'error';
                    resultDiv.innerHTML = `âŒ ä¸Šä¼ å¤±è´¥ (${response.status})<br>${result.error || result.message}<br><pre>${JSON.stringify(result, null, 2)}</pre>`;
                    log('âŒ ä¸Šä¼ å¤±è´¥', result);
                }
            } catch (error) {
                log('âŒ ä¸Šä¼ é”™è¯¯', error);
                resultDiv.className = 'error';
                resultDiv.textContent = `âŒ ä¸Šä¼ é”™è¯¯: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥localStorageä¸­çš„Token
        window.addEventListener('load', () => {
            const token = localStorage.getItem('access_token');
            if (token) {
                currentToken = token;
                log('ğŸ” å‘ç°å·²ä¿å­˜çš„Token', {token: token.substring(0, 30) + '...'});
            }
        });
    </script>
</body>
</html>
