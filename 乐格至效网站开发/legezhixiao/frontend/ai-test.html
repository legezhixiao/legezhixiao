<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI服务测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-container {
            border: 1px solid #d9d9d9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #f6ffed; border: 1px solid #b7eb8f; }
        .error { background-color: #fff2f0; border: 1px solid #ffccc7; }
        .loading { background-color: #e6f7ff; border: 1px solid #91d5ff; }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            resize: vertical;
        }
        .response {
            background: #fafafa;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🤖 AI服务测试页面</h1>
    
    <div class="test-container">
        <h3>1. 后端AI服务健康检查</h3>
        <div id="health-status" class="status loading">检查中...</div>
        <button onclick="checkHealth()">重新检查</button>
    </div>

    <div class="test-container">
        <h3>2. AI对话测试</h3>
        <textarea id="messageInput" placeholder="输入您的问题...">你好，我想写一个科幻小说，有什么建议吗？</textarea>
        <br>
        <button onclick="sendMessage()" id="sendBtn">发送消息</button>
        <button onclick="testContinuation()">测试续写</button>
        <button onclick="testImprovement()">测试改进</button>
        <div id="response" class="response" style="display: none;"></div>
    </div>

    <div class="test-container">
        <h3>3. 认证状态</h3>
        <div id="auth-status" class="status loading">检查中...</div>
        <button onclick="checkAuth()">检查认证</button>
        <button onclick="login()">快速登录</button>
    </div>

    <script>
        // 检查AI服务健康状态
        async function checkHealth() {
            const statusDiv = document.getElementById('health-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = '检查中...';
            
            try {
                const response = await fetch('/api/ai/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `✅ AI服务正常 (${data.provider} - ${data.model})`;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = `⚠️ AI服务状态: ${data.status}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ 无法连接AI服务: ${error.message}`;
            }
        }

        // 检查认证状态
        async function checkAuth() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = '检查中...';
            
            const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            
            if (!token) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '❌ 未登录，请先登录';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `✅ 已登录用户: ${user.username}`;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '❌ 登录状态无效';
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ 认证检查失败: ${error.message}`;
            }
        }

        // 快速登录
        async function login() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@legezhixiao.com',
                        password: 'lekairong8888'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    sessionStorage.setItem('access_token', data.data.accessToken);
                    alert('登录成功！');
                    checkAuth();
                } else {
                    alert('登录失败: ' + data.message);
                }
            } catch (error) {
                alert('登录失败: ' + error.message);
            }
        }

        // 发送消息
        async function sendMessage(type = 'general') {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const responseDiv = document.getElementById('response');
            
            const message = messageInput.value.trim();
            if (!message) {
                alert('请输入消息');
                return;
            }
            
            sendBtn.disabled = true;
            sendBtn.textContent = '发送中...';
            responseDiv.style.display = 'block';
            responseDiv.textContent = '正在生成回复...';
            
            const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            
            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: message,
                        type: type,
                        maxTokens: 1000
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.textContent = `AI回复 (${data.type}, 置信度: ${data.confidence}):\n\n${data.text}`;
                } else {
                    responseDiv.textContent = `错误: ${data.error || data.message}`;
                }
            } catch (error) {
                responseDiv.textContent = `请求失败: ${error.message}`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '发送消息';
            }
        }

        // 测试续写
        function testContinuation() {
            document.getElementById('messageInput').value = '请为以下内容提供续写建议：\n\n在一个遥远的星球上，人类殖民者发现了一种神秘的能量晶体...';
            sendMessage('continuation');
        }

        // 测试改进
        function testImprovement() {
            document.getElementById('messageInput').value = '请改进这段文字：\n\n他走路走得很快，因为他很着急。今天有很重要的事情要做。';
            sendMessage('improvement');
        }

        // 页面加载时自动检查
        window.onload = function() {
            checkHealth();
            checkAuth();
        };
    </script>
</body>
</html>
