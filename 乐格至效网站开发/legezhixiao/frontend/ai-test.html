<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæœåŠ¡æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-container {
            border: 1px solid #d9d9d9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #f6ffed; border: 1px solid #b7eb8f; }
        .error { background-color: #fff2f0; border: 1px solid #ffccc7; }
        .loading { background-color: #e6f7ff; border: 1px solid #91d5ff; }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            resize: vertical;
        }
        .response {
            background: #fafafa;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– AIæœåŠ¡æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-container">
        <h3>1. åç«¯AIæœåŠ¡å¥åº·æ£€æŸ¥</h3>
        <div id="health-status" class="status loading">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkHealth()">é‡æ–°æ£€æŸ¥</button>
    </div>

    <div class="test-container">
        <h3>2. AIå¯¹è¯æµ‹è¯•</h3>
        <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">ä½ å¥½ï¼Œæˆ‘æƒ³å†™ä¸€ä¸ªç§‘å¹»å°è¯´ï¼Œæœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ</textarea>
        <br>
        <button onclick="sendMessage()" id="sendBtn">å‘é€æ¶ˆæ¯</button>
        <button onclick="testContinuation()">æµ‹è¯•ç»­å†™</button>
        <button onclick="testImprovement()">æµ‹è¯•æ”¹è¿›</button>
        <div id="response" class="response" style="display: none;"></div>
    </div>

    <div class="test-container">
        <h3>3. è®¤è¯çŠ¶æ€</h3>
        <div id="auth-status" class="status loading">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkAuth()">æ£€æŸ¥è®¤è¯</button>
        <button onclick="login()">å¿«é€Ÿç™»å½•</button>
    </div>

    <script>
        // æ£€æŸ¥AIæœåŠ¡å¥åº·çŠ¶æ€
        async function checkHealth() {
            const statusDiv = document.getElementById('health-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'æ£€æŸ¥ä¸­...';
            
            try {
                const response = await fetch('/api/ai/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `âœ… AIæœåŠ¡æ­£å¸¸ (${data.provider} - ${data.model})`;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = `âš ï¸ AIæœåŠ¡çŠ¶æ€: ${data.status}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ æ— æ³•è¿æ¥AIæœåŠ¡: ${error.message}`;
            }
        }

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'æ£€æŸ¥ä¸­...';
            
            const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            
            if (!token) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `âœ… å·²ç™»å½•ç”¨æˆ·: ${user.username}`;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = 'âŒ ç™»å½•çŠ¶æ€æ— æ•ˆ';
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`;
            }
        }

        // å¿«é€Ÿç™»å½•
        async function login() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@legezhixiao.com',
                        password: 'lekairong8888'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    sessionStorage.setItem('access_token', data.data.accessToken);
                    alert('ç™»å½•æˆåŠŸï¼');
                    checkAuth();
                } else {
                    alert('ç™»å½•å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage(type = 'general') {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const responseDiv = document.getElementById('response');
            
            const message = messageInput.value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯');
                return;
            }
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';
            responseDiv.style.display = 'block';
            responseDiv.textContent = 'æ­£åœ¨ç”Ÿæˆå›å¤...';
            
            const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            
            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: message,
                        type: type,
                        maxTokens: 1000
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.textContent = `AIå›å¤ (${data.type}, ç½®ä¿¡åº¦: ${data.confidence}):\n\n${data.text}`;
                } else {
                    responseDiv.textContent = `é”™è¯¯: ${data.error || data.message}`;
                }
            } catch (error) {
                responseDiv.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€æ¶ˆæ¯';
            }
        }

        // æµ‹è¯•ç»­å†™
        function testContinuation() {
            document.getElementById('messageInput').value = 'è¯·ä¸ºä»¥ä¸‹å†…å®¹æä¾›ç»­å†™å»ºè®®ï¼š\n\nåœ¨ä¸€ä¸ªé¥è¿œçš„æ˜Ÿçƒä¸Šï¼Œäººç±»æ®–æ°‘è€…å‘ç°äº†ä¸€ç§ç¥ç§˜çš„èƒ½é‡æ™¶ä½“...';
            sendMessage('continuation');
        }

        // æµ‹è¯•æ”¹è¿›
        function testImprovement() {
            document.getElementById('messageInput').value = 'è¯·æ”¹è¿›è¿™æ®µæ–‡å­—ï¼š\n\nä»–èµ°è·¯èµ°å¾—å¾ˆå¿«ï¼Œå› ä¸ºä»–å¾ˆç€æ€¥ã€‚ä»Šå¤©æœ‰å¾ˆé‡è¦çš„äº‹æƒ…è¦åšã€‚';
            sendMessage('improvement');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkHealth();
            checkAuth();
        };
    </script>
</body>
</html>
